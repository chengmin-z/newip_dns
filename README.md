# newip_dns 项目说明
## 1 概述
new_dns是为支持NewIP协议开发的简易版本DNS系统，主要目的是为了让chrominum可以工作在NewIP协议架构之上，除了要对dns_server做DNS服务器的支持之外，还要调研chrominum内核的工作方式。

## 2 Chrominum DNS 工作方式
在Chrominum Projects的项目介绍网站中，关于Network Stack的描述中记录了其地址解析的基本过程。

[Network_Stack网站链接](https://www.chromium.org/developers/design-documents/network-stack)

文中提到Chrominum中的HostResolverImpl使用 getaddrinfo() 来实现host地址解析，那么接下来的分析工作为两部分，一是了解Chrominum通过 getaddrinfo() 后的后续工作，二是要调研如何让 getaddrinfo() 适配NewIP的地址协议。

## 3 dns_newip 特性及使用说明

### 3.1 dns_newip 特性

1. dns_newip 程序本身是一个运行在本地的dns服务器
2. dns_newip 同时以自身dns表响应dns请求与dns远端服务器两种模式工作
3. 使用Makefile进行编译配置
4. 本地模式下支持如下特性：
   - 支持A、AAAA、NIP三种DNS Qtype格式
   - 可以方便的扩展DNS Qtype支持
   - 使用domain type data的格式的DNS本地映射表
   - 支持通过指定DNS映射表中Qtype为NULL的方式进行指定域名DNS屏蔽
5. 中转模式下支持如下特性：
   - 可以任意指定远端DNS Server
   - 内部进行了DNS ID转换，支持无限次转发

### 3.2 dns_newip 使用

1. clone项目仓库

   ```shell
   git clone https://github.com/chengmin-z/newip_dns.git
   ```

2. 进入dns_newip子项目文件夹

   ```shell
   cd dns_newip
   ```

3. 进行编译

   ```shell
   make
   ```

4. 在bin目录中配置自己的dns_data.txt，格式如下：[doamin] [type] [rdata]

   ```
   www.a.com A 0a 03 08 d3
   www.aaaa.com AAAA a2 d5 21 6c a2 d5 21 6c a2 d5 21 6c a2 d5 21 6c
   www.nip.com NIP a2 d5 21 6c a2 d5 21 6c 21 6c a2 d5 21 6c a2 d5 21 6c 21 6c a2 d5 21 6c a2 d5 21 6c 21 6c a2 d5 21 6c a2 d5 21 6c 21 6c a2 d5 21 6c a2 d5 21 6c 21 6c
   www.null.com NULL
   ```

   domain：正常格式即可，最长支持255 Character

   type：仅支持填写A、AAAA、NIP、NULL，其中NULL用于屏蔽域名查询

   rdata：DNS报文rdata区域数据，采用16进制Byte存储

5. 进入bin目录下运行程序

   ```
   sudo ./dns_newip [remote_dns_server] [dns_data_filepath]
   ```

   remote_dns_server：仅支持ipv4的远端DNS服务器地址

   dns_data_filepath：本地DNS映射表文件位置

   备注：由于要绑定53号端口需要root权限

### 3.3 dns_newip 测试

#### 3.3.1 nslookup指定dns服务器测试

在程序开始运行后，可以通过nslookup [domain] 127.0.0.1的格式指定DNS服务器为本地进行测试，如下是配合WrieShark抓包得到的测试结果：

1. 启动本地DNS服务器dns_newip

   ```shell
   sudo ./dns_newip 10.3.9.44 dns_data.txt
   ```

   ![](https://i.loli.net/2021/07/23/SQLivI7hEcb6mnZ.png)

2. 测试在DNS映射表中的IPv4地址查询

   ```shell
   nslookup www.a.com 127.0.0.1
   ```

   ![](https://i.loli.net/2021/07/23/S9QMjpTe3aEWoCX.png)

3. 测试在DNS映射表中的IPv6地址查询

   ```shell
   nslookup www.aaaa.com 127.0.0.1
   ```

   ![](https://i.loli.net/2021/07/23/mYx2ZU4M7fGcwEh.png)

4. 测试在DNS映射表中的NIP地址查询

   ```shell
   nslookup www.nip.com 127.0.0.1
   ```

   ![](https://i.loli.net/2021/07/23/TBSZd6KWvJmPaM1.png)

   ![](https://i.loli.net/2021/07/23/MRb7KBOC8NQygDT.png)

   

5. 测试在DNS映射表中的NULL屏蔽功能

   ```shell
   nslookup www.null.com 127.0.0.1
   ```

   ![](https://i.loli.net/2021/07/23/LG9QZ8HoIXM2ksa.png)

6. 测试中继转发功能

   ```shell
   nslookup www.baidu.com 127.0.0.1
   ```

   ![](https://i.loli.net/2021/07/23/xyMjfPIst9dZpOA.png)

#### 3.3.2 更改系统默认DNS服务测试方法

如果想要系统的DNS服务指定为dns_newip的话，需要更改以下文件，但系统重启后文件会被重置为默认配置。

1. 修改以下文件：

   ```shell
   sudo vim  /etc/resolv.conf
   ```

2. 更改nameserver为以下内容：

   ```shell
   # Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
   #     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
   nameserver 127.0.0.1
   ```

3. 之后系统会使用127.0.0.1:53作为DNS服务器，DNS服务器将收到很多请求如下：

   ![](https://i.loli.net/2021/07/23/aimWHq3Lw1QStr9.png)
